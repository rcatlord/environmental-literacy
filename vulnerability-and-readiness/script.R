# Vulnerability and readiness
# Source: ND-GAIN Country Index (2021)
# URL: https://gain.nd.edu/our-work/country-index/rankings/

library(tidyverse) ; library(rvest) ; library(countrycode) ; library(rnaturalearth) ; library(sf) 
library(biscale) ; library(ggtext) ; library(cowplot)

readiness <- read_html("https://gain-new.crc.nd.edu/ranking/readiness") %>%
  html_element("table") %>%
  html_table(header = NA) %>% 
  as_tibble() %>% 
  select(Country, Readiness = Score)

vulnerability <- read_html("https://gain-new.crc.nd.edu/ranking/vulnerability") %>%
  html_element("table") %>%
  html_table(header = NA) %>% 
  as_tibble() %>% 
  select(Country, Vulnerability = Score) %>% 
  mutate(Vulnerability = as.numeric(Vulnerability))
  
tbl <- left_join(readiness, vulnerability, by = "Country") %>% 
  mutate(iso_a3 = countrycode(Country, "country.name", "iso3c"))

sf <- ne_countries(returnclass = "sf") %>%
  select(iso_a3) %>% 
  left_join(tbl, by = "iso_a3") 

data <- bi_class(sf, x = Readiness, y = Vulnerability, style = "quantile", dim = 2)

map <- ggplot(data) +
  geom_sf(color = "#000000", fill = "#757575", size = 0.01) +
  geom_sf(filter(data, bi_class != "NA-NA"), mapping = aes(fill = bi_class), color = "#000000", size = 0.01, show.legend = FALSE) +
  bi_scale_fill(pal = "DkBlue2", dim = 2) +
  labs(title = "The Global South is most vulnerable to climate change",
       subtitle = "<span style = 'color:#757575;'>ND-GAIN Country Index, 2021</span>",
       caption = "Source: University of Notre Dame Global Adaptation Initiative") +
  theme_minimal(base_size = 14) +
  theme(plot.margin = unit(c(1,4,1,1), "cm"),
        plot.title.position = "plot",
        plot.title = element_text(face = "bold", size = 18),
        plot.subtitle = element_markdown(margin = margin(b = 25)),
        plot.caption = element_text(size = rel(0.8), colour = "#707071", hjust = 0)) +
  coord_sf(crs = "+proj=robin +lat_0=0 +lon_0=0 +x0=0 +y0=0")

legend <- bi_legend(pal = "DkBlue2", 
                    dim = 2, 
                    xlab = "Readiness", 
                    ylab = "Vulnerability", 
                    size = 8,
                    pad_width = 0.01, 
                    pad_color = "#000000")

plot <- ggdraw() +
  draw_plot(map, 0, 0, 1, 1) +
  draw_plot(legend, 0.8, 0.12, 0.2, 0.2)

plot

save_plot("plot.jpeg", plot, base_height = 8, base_aspect_ratio = 1.8)
